# 技术需求文档 (TRD)

## 项目名称
Intestine ASSistant - 肠道健康助手

## 1. 技术架构

### 1.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                      客户端层 (Client)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  iOS App    │  │ Android App │  │   Web App   │          │
│  │  (Swift)    │  │  (Kotlin)   │  │  (React)    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      API 网关层                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  API Gateway (Kong / AWS API Gateway)               │    │
│  │  - 认证授权  - 限流熔断  - 日志记录  - 路由转发      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      服务层 (Backend)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 用户服务    │  │ 记录服务    │  │ AI分析服务  │          │
│  │ User Service│  │Record Service│ │ AI Service  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 统计服务    │  │ 提醒服务    │  │ 同步服务    │          │
│  │Stats Service│  │Notify Service│ │Sync Service │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  PostgreSQL │  │    Redis    │  │  MongoDB    │          │
│  │  (主数据库) │  │  (缓存)     │  │ (日志/分析) │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │     S3      │  │ Elasticsearch│                          │
│  │ (文件存储)  │  │  (搜索)     │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选型

#### 1.2.1 移动端
| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 跨平台框架 | React Native / Flutter | 一套代码多端运行 |
| 状态管理 | Redux Toolkit / Riverpod | 统一状态管理 |
| 本地存储 | SQLite / Realm | 离线数据存储 |
| UI组件库 | React Native Paper / Flutter Material | 统一UI风格 |
| 图表库 | Victory Native / fl_chart | 数据可视化 |

#### 1.2.2 后端
| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 开发语言 | Node.js (TypeScript) / Python | 高效开发、AI集成友好 |
| Web框架 | NestJS / FastAPI | 企业级框架 |
| ORM | Prisma / SQLAlchemy | 类型安全的数据库操作 |
| 消息队列 | Redis / RabbitMQ | 异步任务处理 |
| 定时任务 | Bull / Celery | 提醒任务调度 |

#### 1.2.3 AI服务
| 功能 | 技术选型 | 说明 |
|------|----------|------|
| LLM集成 | OpenAI API / Claude API | 自然语言处理 |
| 本地模型 | Ollama + Llama 3 | 隐私优先的本地分析 |
| 数据分析 | Python (Pandas, NumPy) | 统计分析 |
| 机器学习 | scikit-learn | 异常检测模型 |

#### 1.2.4 基础设施
| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 容器化 | Docker + Kubernetes | 微服务部署 |
| CI/CD | GitHub Actions / GitLab CI | 自动化部署 |
| 监控 | Prometheus + Grafana | 性能监控 |
| 日志 | ELK Stack | 日志收集分析 |
| 云服务 | AWS / 阿里云 | 云基础设施 |

## 2. 数据库设计

### 2.1 概念模型 (ER图)
```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    User     │       │   Record    │       │  Analysis   │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │───┐   │ id (PK)     │───┐   │ id (PK)     │
│ email       │   │   │ user_id(FK) │   │   │ user_id(FK) │
│ password    │   └──▶│ date        │   └──▶│ record_id   │
│ nickname    │       │ time        │       │ score       │
│ avatar      │       │ duration    │       │ insights    │
│ settings    │       │ stool_type  │       │ suggestions │
│ created_at  │       │ color       │       │ created_at  │
│ updated_at  │       │ smell       │       └─────────────┘
└─────────────┘       │ feeling     │
                      │ symptoms    │
                      │ notes       │
                      │ created_at  │
                      │ updated_at  │
                      └─────────────┘
```

### 2.2 数据表设计

#### 2.2.1 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(100),
    avatar_url VARCHAR(500),
    birth_date DATE,
    gender VARCHAR(10),
    health_conditions JSONB,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
```

#### 2.2.2 排便记录表 (bowel_records)
```sql
CREATE TABLE bowel_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    record_date DATE NOT NULL,
    record_time TIME NOT NULL,
    duration_minutes INTEGER,
    stool_type INTEGER CHECK (stool_type BETWEEN 1 AND 7),
    color VARCHAR(50),
    smell_level INTEGER CHECK (smell_level BETWEEN 1 AND 5),
    feeling VARCHAR(50),
    symptoms TEXT[],
    notes TEXT,
    location GEOGRAPHY(POINT),
    is_manual BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_bowel_records_user_date ON bowel_records(user_id, record_date);
CREATE INDEX idx_bowel_records_user_created ON bowel_records(user_id, created_at);
```

#### 2.2.3 AI分析结果表 (ai_analyses)
```sql
CREATE TABLE ai_analyses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    analysis_type VARCHAR(50) NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    health_score DECIMAL(3,1),
    insights JSONB NOT NULL,
    suggestions JSONB NOT NULL,
    warnings JSONB,
    model_version VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_ai_analyses_user_type ON ai_analyses(user_id, analysis_type);
```

#### 2.2.4 提醒设置表 (reminders)
```sql
CREATE TABLE reminders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    reminder_type VARCHAR(50) NOT NULL,
    reminder_time TIME,
    reminder_days INTEGER[],
    is_active BOOLEAN DEFAULT true,
    last_triggered_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_reminders_user_active ON reminders(user_id, is_active);
```

## 3. API接口设计

### 3.1 接口规范
- 基础路径: `/api/v1`
- 认证方式: JWT Bearer Token
- 数据格式: JSON
- 编码: UTF-8

### 3.2 核心接口

#### 3.2.1 用户模块
```yaml
# 用户注册
POST /auth/register
Request:
  {
    "email": "user@example.com",
    "password": "securePassword123",
    "nickname": "用户昵称"
  }
Response:
  {
    "code": 200,
    "data": {
      "user_id": "uuid",
      "token": "jwt_token"
    }
  }

# 用户登录
POST /auth/login
Request:
  {
    "email": "user@example.com",
    "password": "securePassword123"
  }
Response:
  {
    "code": 200,
    "data": {
      "user_id": "uuid",
      "token": "jwt_token",
      "refresh_token": "refresh_token"
    }
  }
```

#### 3.2.2 记录模块
```yaml
# 创建排便记录
POST /records
Headers:
  Authorization: Bearer {token}
Request:
  {
    "record_date": "2024-01-15",
    "record_time": "08:30:00",
    "duration_minutes": 10,
    "stool_type": 4,
    "color": "brown",
    "smell_level": 2,
    "feeling": "smooth",
    "symptoms": [],
    "notes": ""
  }
Response:
  {
    "code": 200,
    "data": {
      "record_id": "uuid",
      "created_at": "2024-01-15T08:35:00Z"
    }
  }

# 获取记录列表
GET /records?start_date=2024-01-01&end_date=2024-01-31&page=1&limit=20
Headers:
  Authorization: Bearer {token}
Response:
  {
    "code": 200,
    "data": {
      "records": [...],
      "pagination": {
        "total": 45,
        "page": 1,
        "limit": 20
      }
    }
  }

# 更新记录
PUT /records/{record_id}
Headers:
  Authorization: Bearer {token}
Request:
  {
    "stool_type": 3,
    "notes": "更新备注"
  }

# 删除记录
DELETE /records/{record_id}
Headers:
  Authorization: Bearer {token}
```

#### 3.2.3 统计模块
```yaml
# 获取统计数据
GET /stats/summary?period=week|month|year
Headers:
  Authorization: Bearer {token}
Response:
  {
    "code": 200,
    "data": {
      "total_records": 28,
      "avg_frequency_per_day": 1.2,
      "avg_duration_minutes": 8.5,
      "stool_type_distribution": {
        "1": 2, "2": 3, "3": 8, "4": 10, "5": 3, "6": 1, "7": 1
      },
      "time_distribution": {
        "morning": 15, "afternoon": 5, "evening": 8
      },
      "health_score": 78.5
    }
  }

# 获取趋势数据
GET /stats/trends?metric=frequency|duration|type&period=month
Headers:
  Authorization: Bearer {token}
```

#### 3.2.4 AI分析模块
```yaml
# 请求AI分析
POST /ai/analyze
Headers:
  Authorization: Bearer {token}
Request:
  {
    "analysis_type": "weekly|monthly|custom",
    "start_date": "2024-01-01",
    "end_date": "2024-01-31"
  }
Response:
  {
    "code": 200,
    "data": {
      "analysis_id": "uuid",
      "health_score": 75,
      "insights": [
        {
          "type": "pattern",
          "title": "排便时间规律",
          "description": "您的排便时间主要集中在早晨..."
        }
      ],
      "suggestions": [
        {
          "category": "diet",
          "suggestion": "建议增加膳食纤维摄入..."
        }
      ],
      "warnings": []
    }
  }

# 获取历史分析
GET /ai/analyses
Headers:
  Authorization: Bearer {token}
```

## 4. AI分析模块设计

### 4.1 分析流程
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  数据收集   │───▶│  数据预处理 │───▶│  特征提取   │
└─────────────┘    └─────────────┘    └─────────────┘
                                            │
                                            ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  结果输出   │◀───│  LLM分析    │◀───│  规则引擎   │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 4.2 分析维度
| 维度 | 指标 | 分析方法 |
|------|------|----------|
| 频率分析 | 每日排便次数 | 统计分析 + 异常检测 |
| 时间分析 | 排便时间分布 | 聚类分析 |
| 形态分析 | 布里斯托类型分布 | 趋势分析 |
| 时长分析 | 平均排便时长 | 统计分析 |
| 关联分析 | 症状与形态关联 | 关联规则挖掘 |

### 4.3 Prompt模板
```
你是一位专业的肠道健康顾问。基于用户过去{period}天的排便记录数据，请提供健康分析。

用户数据摘要：
- 记录天数：{days}天
- 总记录次数：{total_records}次
- 平均每日次数：{avg_frequency}
- 布里斯托类型分布：{type_distribution}
- 平均时长：{avg_duration}分钟
- 主要排便时段：{peak_time}
- 常见症状：{common_symptoms}

请从以下方面进行分析：
1. 整体健康评分（0-100分）
2. 排便习惯分析
3. 潜在健康风险
4. 饮食生活建议

注意：你的建议仅供参考，不能替代专业医疗诊断。
```

### 4.4 本地AI方案（隐私优先）
```yaml
方案一：Ollama本地部署
  - 模型：Llama 3 8B / Mistral 7B
  - 优点：完全本地化，隐私安全
  - 缺点：需要用户设备性能支持

方案二：混合方案
  - 敏感数据：本地模型处理
  - 复杂分析：脱敏后云端处理
  - 优点：平衡性能与隐私
```

## 5. 安全设计

### 5.1 认证授权
```yaml
认证方式：
  - JWT Token认证
  - Token有效期：Access Token 2小时，Refresh Token 7天
  - 支持生物识别（指纹/Face ID）

授权模型：
  - RBAC（基于角色的访问控制）
  - 用户只能访问自己的数据
```

### 5.2 数据安全
```yaml
传输安全：
  - 全站HTTPS
  - 证书固定（Certificate Pinning）

存储安全：
  - 敏感数据AES-256加密
  - 密码bcrypt哈希存储
  - 本地数据库SQLCipher加密

隐私保护：
  - 数据匿名化处理
  - 支持数据导出与删除
  - 符合GDPR/个人信息保护法
```

### 5.3 API安全
```yaml
防护措施：
  - 请求频率限制（Rate Limiting）
  - SQL注入防护
  - XSS防护
  - CSRF Token
  - 请求签名验证
```

## 6. 性能优化

### 6.1 客户端优化
```yaml
启动优化：
  - 延迟加载非关键模块
  - 启动页预加载缓存数据

列表优化：
  - 虚拟列表（Virtualized List）
  - 分页加载
  - 下拉刷新 + 上拉加载更多

缓存策略：
  - 本地SQLite缓存
  - 图片缓存
  - API响应缓存
```

### 6.2 服务端优化
```yaml
数据库优化：
  - 索引优化
  - 查询优化
  - 读写分离
  - 连接池管理

缓存策略：
  - Redis热点数据缓存
  - 查询结果缓存
  - 会话缓存

异步处理：
  - AI分析任务异步化
  - 消息队列解耦
  - 批量数据处理
```

## 7. 测试策略

### 7.1 测试类型
| 类型 | 工具 | 覆盖率目标 |
|------|------|------------|
| 单元测试 | Jest / Pytest | > 80% |
| 集成测试 | Supertest / pytest-asyncio | > 70% |
| E2E测试 | Detox / Appium | 核心流程100% |
| 性能测试 | k6 / JMeter | 关键接口 |
| 安全测试 | OWASP ZAP | 定期扫描 |

### 7.2 测试用例示例
```yaml
记录功能测试：
  - 正常创建记录
  - 必填字段验证
  - 数据格式验证
  - 边界值测试
  - 并发创建测试
  - 离线创建同步测试

AI分析测试：
  - 空数据分析
  - 单条记录分析
  - 大量数据分析
  - 异常数据处理
  - 响应时间测试
```

## 8. 部署架构

### 8.1 生产环境部署
```
┌─────────────────────────────────────────────────────────────┐
│                         CDN                                  │
│                    (CloudFront / 阿里云CDN)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      负载均衡器                              │
│                    (ALB / Nginx)                            │
└─────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
     ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
     │  API Server │   │  API Server │   │  API Server │
     │  (Node 1)   │   │  (Node 2)   │   │  (Node 3)   │
     └─────────────┘   └─────────────┘   └─────────────┘
            │                 │                 │
            └─────────────────┼─────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
     ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
     │  PostgreSQL │   │    Redis    │   │   MongoDB   │
     │   (主从)    │   │  (集群)     │   │  (副本集)   │
     └─────────────┘   └─────────────┘   └─────────────┘
```

### 8.2 CI/CD流程
```yaml
开发流程：
  1. Feature分支开发
  2. Pull Request代码审查
  3. 自动化测试
  4. 合并到主分支
  5. 自动构建镜像
  6. 部署到测试环境
  7. QA测试
  8. 部署到生产环境

部署策略：
  - 蓝绿部署
  - 金丝雀发布
  - 自动回滚
```

## 9. 监控告警

### 9.1 监控指标
```yaml
应用监控：
  - 请求QPS
  - 响应时间（P50/P95/P99）
  - 错误率
  - 活跃用户数

基础设施监控：
  - CPU使用率
  - 内存使用率
  - 磁盘IO
  - 网络流量

业务监控：
  - 日新增记录数
  - AI分析调用次数
  - 用户留存率
```

### 9.2 告警规则
| 指标 | 阈值 | 级别 |
|------|------|------|
| API错误率 | > 1% | Warning |
| API错误率 | > 5% | Critical |
| 响应时间P95 | > 2s | Warning |
| CPU使用率 | > 80% | Warning |
| 内存使用率 | > 85% | Critical |
| 数据库连接数 | > 80% | Warning |

## 10. 开发计划

### 10.1 里程碑
| 阶段 | 内容 | 周期 |
|------|------|------|
| Phase 1 | 基础架构搭建、数据库设计 | 2周 |
| Phase 2 | 核心记录功能开发 | 3周 |
| Phase 3 | 统计分析功能开发 | 2周 |
| Phase 4 | AI分析模块集成 | 3周 |
| Phase 5 | 测试与优化 | 2周 |
| Phase 6 | 上线部署 | 1周 |

### 10.2 技术债务管理
- 代码审查制度
- 定期重构计划
- 文档同步更新
- 自动化测试维护
